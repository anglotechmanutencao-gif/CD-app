<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <title>Dados do Banco</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/estilos.css') }}" />
</head>
<body>

    <!-- Menu de navega√ß√£o -->
    <nav class="navbar">
        <div class="nav-container">
            <span class="logo">Saurus Dashboard</span>
            <ul class="nav-links">
                <li><a href="/">In√≠cio</a></li>
                <li><a href="/analise">An√°lise</a></li>
                <li><a href="{{ url_for('cadastrar_colaborador') }}">Cadastro de colaborador</a></li>
                <li><a href="#">Ranking dos separadores</a></li>
                <li><a href="#">Sair</a></li>
            </ul>
        </div>
    </nav>

    <h2>Dados do Banco</h2>

    <div class="linha-botoes">
        <!-- Bot√µes de categoria (lado esquerdo) -->
        <div class="botoes-categorias">
            <button class="categoria-todos" onclick="filtrarCategoria('todos')">Todos</button>
            <button class="categoria-indefinido" onclick="filtrarCategoria('Indefinido')">Indefinido</button>
            <button class="categoria-entrega" onclick="filtrarCategoria('Entrega')">Entrega</button>
            <button class="categoria-palete" onclick="filtrarCategoria('Palete fechado')">Palete fechado</button>
            <button class="categoria-destilado" onclick="filtrarCategoria('Destilados')">Destilados</button>
            <button class="categoria-separacao" onclick="filtrarCategoria('Separa√ß√£o')">Separa√ß√£o</button>
        </div>

        <!-- Bot√µes de dias (lado direito) -->
        <div class="semana-botoes">
            <button class="botao-nao-definido" onclick="filtrarPorDia('nao-definido')">N√£o definido</button>
            <button class="botao-semana" onclick="filtrarPorDia('semana')">Semana</button>
            <button class="botao-segunda" onclick="filtrarPorDia('segunda')">Segunda</button>
            <button class="botao-terca" onclick="filtrarPorDia('terca')">Ter√ßa</button>
            <button class="botao-quarta" onclick="filtrarPorDia('quarta')">Quarta</button>
            <button class="botao-quinta" onclick="filtrarPorDia('quinta')">Quinta</button>
            <button class="botao-sexta" onclick="filtrarPorDia('sexta')">Sexta</button>
        </div>
    </div>

    <table>
        <thead>
            <tr>
                {% for coluna in dados[0].keys() %}
                    {% if coluna != 'mov_idMov' %}
                        <th>{{ nomes_colunas[coluna] }}</th>
                    {% endif %}
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for linha in dados %}
                <tr data-id="{{ linha['mov_idMov'] }}">
                    {% for coluna in linha.keys() %}
                        {% if coluna != 'mov_idMov' %}

                            {% if coluna == 'dest_fone' %}
                                <td data-label="{{ nomes_colunas[coluna] }}">
                                    <input type="text"
                                        value="{{ linha[coluna] }}"
                                        data-id="{{ linha['mov_idMov'] }}"
                                        data-coluna="{{ coluna }}"
                                        oninput="mascararTelefoneInput(this)"
                                        onblur="atualizarTelefoneInput(this)"
                                        maxlength="15" />
                                </td>

                            {% elif coluna == 'Data' %}
                                {% set valor_data = linha[coluna] if linha[coluna] else '' %}
                                {% set tem_data = valor_data != '' %}

                                <td data-label="{{ nomes_colunas[coluna] }}"
                                    class="{{ 'data-ok' if tem_data else 'data-vazia' }}">

                                    {% if not tem_data %}
                                        <!-- Caso n√£o tenha data salva -->
                                        <select class="select-data-completa"
                                                data-id="{{ linha['mov_idMov'] }}"
                                                data-coluna="{{ coluna }}"
                                                onchange="atualizarDataHora(this)">
                                            <option value="" selected>Indefinido</option>
                                            {% for data in datas_validas %}
                                                <option value="{{ data }}">{{ data }}</option>
                                            {% endfor %}
                                        </select>

                                        <select class="select-hora-minuto"
                                                data-id="{{ linha['mov_idMov'] }}"
                                                data-coluna="{{ coluna }}"
                                                onchange="atualizarDataHora(this)">
                                            <option value="" selected>Indefinido</option>
                                            {% for h in range(7, 20) %}
                                                {% for m in range(0, 60, 10) %}
                                                    {% if not (h == 19 and m > 0) %}
                                                        {% set valor = '%02d:%02d' % (h, m) %}
                                                        <option value="{{ valor }}">{{ valor }}</option>
                                                    {% endif %}
                                                {% endfor %}
                                            {% endfor %}
                                        </select>

                                    {% else %}
                                        <!-- Caso j√° tenha data salva -->
                                        {% set partes = valor_data.split(' - ') %}
                                        {% set data_formatada = partes[0] ~ ' - ' ~ partes[1] if partes|length >= 2 else '' %}
                                        {% set hora_formatada = partes[2] if partes|length > 2 else '07:00' %}

                                        {# Garante que a data salva esteja na lista mesmo que seja anterior ao range #}
                                        {% if data_formatada not in datas_validas %}
                                            {% set datas_validas = datas_validas + [data_formatada] %}
                                        {% endif %}

                                        <select class="select-data-completa"
                                                data-id="{{ linha['mov_idMov'] }}"
                                                data-coluna="{{ coluna }}"
                                                onchange="atualizarDataHora(this)">
                                            {% for data in datas_validas %}
                                                <option value="{{ data }}"
                                                    {% if data.split(' - ')[0] == data_formatada.split(' - ')[0] %}
                                                        selected
                                                    {% endif %}>
                                                    {{ data }}
                                                </option>
                                            {% endfor %}
                                        </select>

                                        <select class="select-hora-minuto"
                                                data-id="{{ linha['mov_idMov'] }}"
                                                data-coluna="{{ coluna }}"
                                                onchange="atualizarDataHora(this)">
                                            {% for h in range(7, 20) %}
                                                {% for m in range(0, 60, 10) %}
                                                    {% if not (h == 19 and m > 0) %}
                                                        {% set valor = '%02d:%02d' % (h, m) %}
                                                        <option value="{{ valor }}" {% if valor == hora_formatada %}selected{% endif %}>
                                                            {{ valor }}
                                                        </option>
                                                    {% endif %}
                                                {% endfor %}
                                            {% endfor %}
                                        </select>
                                    {% endif %}
                                </td>

                            {% elif coluna == 'status' %}
                                <td data-label="{{ nomes_colunas[coluna] }}">
                                    <button class="btn-iniciar"
                                            data-id="{{ linha['mov_idMov'] }}"
                                            onclick="iniciarAcao(this)">
                                        Iniciar
                                    </button>
                                </td>

                            {% elif coluna == 'categoria' %}
                                <td data-label="{{ nomes_colunas[coluna] }}">
                                    <select class="categoria-select"
                                            data-id="{{ linha['mov_idMov'] }}"
                                            data-coluna="{{ coluna }}"
                                            onchange="atualizarCategoria(this); aplicarCor(this)">
                                        <option value="Indefinido" style="background-color: #7f8c8d; color: white;" {% if linha[coluna] == 'Indefinido' %}selected{% endif %}>Indefinido</option>
                                        <option value="Entrega" style="background-color: #3498db; color: white;" {% if linha[coluna] == 'Entrega' %}selected{% endif %}>Entrega</option>
                                        <option value="Palete" style="background-color: #9b59b6; color: white;" {% if linha[coluna] == 'Palete' %}selected{% endif %}>Palete</option>
                                        <option value="Separa√ß√£o" style="background-color: #27ae60; color: white;" {% if linha[coluna] == 'Separa√ß√£o' %}selected{% endif %}>Separa√ß√£o</option>
                                        <option value="Destilado" style="background-color: #e67e22; color: white;" {% if linha[coluna] == 'Destilado' %}selected{% endif %}>Destilado</option>
                                    </select>
                                </td>
                            
                            {% elif coluna == 'pdf' %}
                                <td data-label="{{ nomes_colunas[coluna] }}">
                                    {% set nome_arquivo = linha[coluna].replace('static\\pdfjs\\', '') %}
                                    <a href="{{ url_for('static', filename='pdfjs/' ~ nome_arquivo) }}"
                                    target="_blank"
                                    class="btn-ver-pdf">üìÑ Ver PDF</a>
                                </td>

                            {% elif coluna == 'Informa√ß√µes' %}
                                <td data-label="{{ nomes_colunas[coluna] }}">
                                    <textarea class="bloco-anotacoes"
                                              data-id="{{ linha['mov_idMov'] }}"
                                              data-coluna="{{ coluna }}"
                                              onblur="atualizarInformacoes(this)">{{ linha[coluna] }}</textarea>
                                </td>

                            {% else %}
                                <td data-label="{{ nomes_colunas[coluna] }}">{{ linha[coluna] }}</td>
                            {% endif %}

                        {% endif %}
                    {% endfor %}
                </tr>
            {% endfor %}
        </tbody>
    </table>

<script>
    // M√°scara de telefone no input
    function mascararTelefoneInput(input) {
        let texto = input.value.replace(/\D/g, '');
        if (texto.length <= 10) {
            texto = texto.replace(/^(\d{2})(\d{4})(\d{0,4})$/, "($1) $2-$3");
        } else {
            texto = texto.replace(/^(\d{2})(\d{5})(\d{0,4})$/, "($1) $2-$3");
        }
        input.value = texto;
    }

    function atualizarTelefoneInput(input) {
        const novoValor = input.value.trim();
        const id = input.getAttribute('data-id');
        const coluna = input.getAttribute('data-coluna');

        fetch('/atualizar-telefone', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: id, coluna: coluna, valor: novoValor })
        })
        .then(response => {
            if (!response.ok) alert('Erro ao atualizar telefone!');
        })
        .catch(() => alert('Erro na comunica√ß√£o com o servidor!'));
    }

    function iniciarAcao(botao) {
        const idMov = botao.getAttribute('data-id');

        fetch('/iniciar-status', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: idMov })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'ok') {
                alert("Status iniciado com sucesso!");
            } else {
                alert("Erro: " + (data.erro || "desconhecido"));
            }
        })
        .catch(() => alert("Erro ao comunicar com o servidor."));
    }

    function atualizarCategoria(select) {
        const novoValor = select.value;
        const id = select.getAttribute('data-id');
        const coluna = select.getAttribute('data-coluna');

        fetch('/atualizar-categoria', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: id, coluna: coluna, valor: novoValor })
        })
        .then(response => {
            if (!response.ok) alert('Erro ao atualizar categoria!');
        })
        .catch(() => alert('Erro de comunica√ß√£o com o servidor!'));
    }

    // Aplica cor no select da categoria
    function aplicarCor(select) {
        select.classList.remove(
            'categoria-indefinido',
            'categoria-entrega',
            'categoria-palete',
            'categoria-separacao',
            'categoria-destilado'
        );

        switch (select.value) {
            case 'Indefinido':
                select.classList.add('categoria-indefinido');
                break;
            case 'Entrega':
                select.classList.add('categoria-entrega');
                break;
            case 'Palete':
                select.classList.add('categoria-palete');
                break;
            case 'Separa√ß√£o':
                select.classList.add('categoria-separacao');
                break;
            case 'Destilado':
                select.classList.add('categoria-destilado');
                break;
        }
    }

document.addEventListener('DOMContentLoaded', function () {
    const selects = document.querySelectorAll('.categoria-select');
    selects.forEach(aplicarCor);

    // Atualiza visualiza√ß√£o da data
    const datetimeInputs = document.querySelectorAll('.datetime-input');
    datetimeInputs.forEach(input => atualizarVisualizacaoDataHora(input));
});

document.addEventListener("DOMContentLoaded", function () {
    const inputsHora = document.querySelectorAll("input[type='time']");

    inputsHora.forEach(input => {
        input.setAttribute("step", "600"); // Garante que o seletor mostre s√≥ de 10 em 10

        input.addEventListener("change", function () {
            const [hora, minuto] = this.value.split(":").map(Number);

            if (minuto % 10 !== 0) {
                alert("Por favor, selecione um hor√°rio com minutos m√∫ltiplos de 10 (ex: 14:00, 14:10, 14:20...)");
                this.value = ""; // Limpa o campo
            }
        });
    });
});

function atualizarVisualizacaoDataHora(input) {
const valor = input.value;
const span = input.parentElement.querySelector('.data-formatada');

    if (!valor) {
        span.textContent = '--';
        span.className = 'data-formatada';
        return;
    }

    const data = new Date(valor);
    if (isNaN(data)) {
        span.textContent = '--';
        span.className = 'data-formatada';
        return;
    }

    const diasSemana = [
        'Domingo', 'Segunda-feira', 'Ter√ßa-feira',
        'Quarta-feira', 'Quinta-feira', 'Sexta-feira', 'S√°bado'
    ];

    const nomesClasses = [
        'domingo', 'segunda', 'terca',
        'quarta', 'quinta', 'sexta', 'sabado'
    ];

    const diaSemanaIndex = data.getDay();
    const diaSemana = diasSemana[diaSemanaIndex];
    const classeDia = `dia-${nomesClasses[diaSemanaIndex]}`;

    span.textContent = `${diaSemana}`;
    span.className = `data-formatada ${classeDia}`;
}

function atualizarInformacoes(textarea) {
    const novoValor = textarea.value.trim();
    const id = textarea.getAttribute('data-id');
    const coluna = textarea.getAttribute('data-coluna');

    fetch('/atualizar-informacoes', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id: id, coluna: coluna, valor: novoValor })
    })
    .then(response => {
        if (!response.ok) alert('Erro ao atualizar informa√ß√µes!');
    })
    .catch(() => alert('Erro de comunica√ß√£o com o servidor!'));
}

function filtrarPorDia(dia) {
    alert("Bot√£o clicado: " + dia);
    // Aqui voc√™ pode:
    // - Filtrar colunas
    // - Recarregar com dados de um dia espec√≠fico
    // - Destacar c√©lulas
    // - Enviar requisi√ß√£o para o backend
}

function filtrarPorDia(dia) {
    // Remove a sele√ß√£o de todos os bot√µes
    const botoes = document.querySelectorAll('.semana-botoes button');
    botoes.forEach(botao => botao.classList.remove('botao-selecionado'));

    // Adiciona a sele√ß√£o ao bot√£o clicado
    const botaoClicado = event.target;
    botaoClicado.classList.add('botao-selecionado');

    // Aqui voc√™ pode adicionar l√≥gica de filtro, destaque etc.
    console.log("Selecionado:", dia);
}

function filtrarCategoria(categoria) {
    const botoes = document.querySelectorAll('.botoes-categorias button');
    botoes.forEach(botao => botao.classList.remove('botao-selecionado'));

    const botaoClicado = event.target;
    botaoClicado.classList.add('botao-selecionado');

    console.log("Categoria selecionada:", categoria);
}


// Fun√ß√£o para corrigir o dia da semana de uma data "dd/mm/yyyy" de forma consistente
function corrigirDiaSemana(dataStr) {
    const [dia, mes, ano] = dataStr.split("/").map(Number);
    // Cria a data como UTC, evitando problemas de fuso hor√°rio
    const dataObj = new Date(Date.UTC(ano, mes - 1, dia));
    if (isNaN(dataObj)) return null;

    const diasSemana = [
        "Domingo", "Segunda-feira", "Ter√ßa-feira",
        "Quarta-feira", "Quinta-feira", "Sexta-feira", "S√°bado"
    ];
    return diasSemana[dataObj.getUTCDay()]; // usar getUTCDay para UTC
}

function atualizarDataHora(element) {
    const td = element.closest("td");
    const id = element.getAttribute("data-id");
    const coluna = element.getAttribute("data-coluna");

    const selectData = td.querySelector(".select-data-completa");
    const selectHoraMinuto = td.querySelector(".select-hora-minuto");

    const dataSelecionada = selectData.value.split(" - ")[0];
    const horaSelecionada = selectHoraMinuto.value;

    if (!dataSelecionada || !horaSelecionada) {
        alert("Selecione uma data e hor√°rio v√°lidos.");
        return;
    }

    const diaSemanaCorreto = corrigirDiaSemana(dataSelecionada);
    if (!diaSemanaCorreto) {
        alert("Data inv√°lida!");
        return;
    }

    const novaOpcao = `${dataSelecionada} - ${diaSemanaCorreto}`;

    // Atualiza o select
    if (![...selectData.options].some(opt => opt.value === novaOpcao)) {
        const nova = document.createElement("option");
        nova.value = novaOpcao;
        nova.textContent = novaOpcao;
        selectData.appendChild(nova);
    }
    selectData.value = novaOpcao;

    const valorFinal = `${novaOpcao} - ${horaSelecionada}`;

    selectData.disabled = selectHoraMinuto.disabled = true;
    td.style.backgroundColor = "#fff3cd";

    fetch("/atualizar-data", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id, coluna, valor: valorFinal })
    })
    .then(res => {
        if (!res.ok) throw new Error("Erro ao atualizar a data!");
        td.style.backgroundColor = "#d4edda";
        setTimeout(() => td.style.backgroundColor = "", 1000);
    })
    .catch(err => {
        console.error(err);
        alert("Erro ao salvar data/hora!");
        td.style.backgroundColor = "#f8d7da";
    })
    .finally(() => {
        selectData.disabled = selectHoraMinuto.disabled = false;
    });
}

// Atualiza o dia da semana instantaneamente ao mudar a data
document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll(".select-data-completa").forEach(select => {
        select.addEventListener("change", () => {
            const dataSelecionada = select.value.split(" - ")[0];
            const diaSemanaCorreto = corrigirDiaSemana(dataSelecionada);
            if (!diaSemanaCorreto) return;

            const novaOpcao = `${dataSelecionada} - ${diaSemanaCorreto}`;
            if (![...select.options].some(opt => opt.value === novaOpcao)) {
                const nova = document.createElement("option");
                nova.value = novaOpcao;
                nova.textContent = novaOpcao;
                select.appendChild(nova);
            }
            select.value = novaOpcao;
        });
    });
});



</script>

</body>
</html>
